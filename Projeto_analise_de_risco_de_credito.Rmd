```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
```


## Avaliação de Risco de Crédito

Para esta análise, vamos usar um conjunto de dados German Credit Data, já devidamente limpo e organizado para a criação do modelo preditivo.

Todo o projeto será descrito de acordo com suas etapas. 


## Etapa 1 - Coletando os Dados

Aqui está a coleta de dados, neste caso um arquivo csv.


```{r coleta}
# Coletando dados
credit.df <- read.csv("credit_dataset.csv", header = TRUE, sep = ",")
nomesDasColunas <- c("Pontuacao.de.credito", "Balanco.Patrimonial", "Duracao.em.meses.do.credito", "status.do.pagamento.de.credito", "Finalidade.do.credito", "Montante.de.credito", "Poupanca", "Duracao.do.Emprego", "Taxa.Prestacao", "Status.Conjugal", "Fiador", "Duracao.da.Residencia", "Ativos.Correntes", "Idade", "Outros.Creditos", "Tipo.de.Apartamento", "Credito.de.bancos", "Ocupacao", "Dependentes", "Telefone", "Trabalhador.estrangeiro")
colnames(credit.df) <- nomesDasColunas
```

```{r dicionario}
glimpse(credit.df)                # Do Cliente:____________________________________________________
# credit.rating                   - Pontuacao.de.credito                        - boolean 0 a 1
# account.balance                 - Balanco.Patrimonial                         - 1 a 3
# credit.duration.months          - Duracao.em.meses.do.credito                 - 4 a 72
# previous.credit.payment.status  - status.do.pagamento.de.credito              - 1 a 3
# credit.purpose                  - Finalidade.do.credito                       - 1 a 4
# credit.amount                   - Montante.de.credito                         - 250 a 18.424
# savings                         - Poupanca                                    - 1 a 4
# employment.duration             - Duracao.do.Emprego                          - 1 a 4
# installment.rate                - Taxa.Prestacao                              - 1 a 4
# marital.status                  - Status.Conjugal                             - 1 a 4
# guarantor                       - Fiador                                      - 1 a 2
# residence.duration              - Duracao.da.Residencia                       - 1 a 4
# current.assets                  - Ativos.Correntes                            - 1 a 4
# age                             - Idade                                       - 19 a 75
# other.credits                   - Outros.Creditos                             - 1 a 2
# apartment.type                  - Tipo.de.Apartamento                         - 1 a 3
# bank.credits                    - Credito.de.bancos                           - 1 a 2
# occupation                      - Ocupacao                                    - 1 a 4
# dependents                      - Dependentes                                 - 1 a 2
# telephone                       - Telefone                                    - 1 a 2
# foreign.worker                  - Trabalhador.estrangeiro                     - 1 a 2
```

## Etapa 2 - Normalizando os Dados



```{r normalizando}
## Convertendo as variáveis para o tipo fator (categórica)
to.factors <- function(df, variables){
  for (variable in variables){
    df[[variable]] <- as.factor(df[[variable]])
  }
  return(df)
}

## Normalização
scale.features <- function(df, variables){
  for (variable in variables){
    df[[variable]] <- scale(df[[variable]], center=T, scale=T)
  }
  return(df)
}

# Normalizando as variáveis
numeric.vars <- c("Duracao.em.meses.do.credito", "Idade", "Montante.de.credito")
credit.df <- scale.features(credit.df, numeric.vars)

# Variáveis do tipo fator
categorical.vars <- c('Pontuacao.de.credito', 'Balanco.Patrimonial', 'status.do.pagamento.de.credito',
                      'Finalidade.do.credito', 'Poupanca', 'Duracao.do.Emprego', 'Taxa.Prestacao',
                      'Status.Conjugal', 'Fiador', 'Duracao.da.Residencia', 'Ativos.Correntes',
                      'Outros.Creditos', 'Tipo.de.Apartamento', 'Credito.de.bancos', 'Ocupacao', 
                      'Dependentes', 'Telefone', 'Trabalhador.estrangeiro')

credit.df <- to.factors(df = credit.df, variables = categorical.vars)

```


## Etapa 3 - Dividindo os dados em dados de treino e de teste


```{r treinamento}
# Dividindo os dados em treino e teste - 60:40 ratio
indexes <- sample(1:nrow(credit.df), size = 0.6 * nrow(credit.df))
train.data <- credit.df[indexes,]

test.data <- credit.df[-indexes,]

```


## Etapa 4 - Feature Selection



```{r performance}
library(caret) 
library(randomForest) 

# Função para seleção de variáveis
run.feature.selection <- function(num.iters=10, feature.vars, class.var){
  set.seed(5)
  variable.sizes <- 1:5
  control <- rfeControl(functions = rfFuncs, method = "cv", 
                        verbose = FALSE, returnResamp = "all", 
                        number = num.iters)
  results.rfe <- rfe(x = feature.vars, y = class.var, 
                     sizes = variable.sizes, 
                     rfeControl = control)
  return(results.rfe)
}

# Executando a função
rfe.results <- run.feature.selection(feature.vars = train.data[,-1], 
                                     class.var = train.data[,1])


# Visualizando os resultados
rfe.results
varImp((rfe.results))
```


## Etapa 5 - Criando e Avaliando a Primeira Versão do Modelo
 
```{r avaliando}
# Criando e Avaliando o Modelo
library(caret) 
library(ROCR) 

# Biblioteca de utilitários para construção de gráficos
source("grafico.R") 

## separate feature and class variables
test.feature.vars <- test.data[,-1]
test.class.var <- test.data[,1]

# Construindo um modelo de regressão logística
formula.init <- "Pontuacao.de.credito ~ ."
formula.init <- as.formula(formula.init)
lr.model <- glm(formula = formula.init, data = train.data, family = "binomial")

# Visualizando o modelo
summary(lr.model)

# Testando o modelo nos dados de teste
lr.predictions <- predict(lr.model, test.data, type="response")
lr.predictions <- round(lr.predictions)

# Avaliando o modelo
confusionMatrix(table(data = lr.predictions, reference = test.class.var), positive = '1')
```


## Etapa 6 - Otimizando o Modelo


```{r otimizando}
## Feature selection
formula <- "Pontuacao.de.credito ~ ."
formula <- as.formula(formula)
control <- trainControl(method = "repeatedcv", number = 10, repeats = 2)
model <- train(formula, data = train.data, method = "glm", trControl = control)
importance <- varImp(model, scale = FALSE)
plot(importance)


# Construindo o modelo com as variáveis selecionadas
formula.new <- "Pontuacao.de.credito ~ Balanco.Patrimonial + Finalidade.do.credito + status.do.pagamento.de.credito + Poupanca + Duracao.em.meses.do.credito"
formula.new <- as.formula(formula.new)
lr.model.new <- glm(formula = formula.new, data = train.data, family = "binomial")

# Visualizando o modelo
summary(lr.model.new)

# Testando o modelo nos dados de teste
lr.predictions.new <- predict(lr.model.new, test.data, type="response") 
lr.predictions.new <- round(lr.predictions.new)

# Avaliando o modelo
confusionMatrix(table(data=lr.predictions.new, reference=test.class.var), positive='1')
```

## Etapa 7 - Curva ROC e Avaliação Final do Modelo

```{r curva}
# Avaliando a performance do modelo

# Criando curvas ROC
lr.model.best <- lr.model
lr.prediction.values <- predict(lr.model.best, test.feature.vars, type = "response")
predictions <- prediction(lr.prediction.values, test.class.var)
par(mfrow = c(1,2))
plot.roc.curve(predictions, title.text = "Curva ROC")
plot.pr.curve(predictions, title.text = "Curva Precision/Recall")
```